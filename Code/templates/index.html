<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Floorplan to 3D | AI Converter</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <header>
      <h1>üè† Floorplan to 3D</h1>
      <p class="subtitle">
        Transform your 2D blueprints into interactive 3D models instantly.
      </p>
    </header>

    <div class="main-card">
      <div class="upload-area">
        <label for="fileInput" class="custom-file-upload">
          <span id="fileNameDisplay">üìÇ Click to Select Floorplan Image</span>
        </label>
        <input type="file" id="fileInput" accept="image/*" />

        <button class="generate-btn" onclick="uploadAndRun()" id="runBtn">
          Generate 3D Model
        </button>
        <div id="statusText">Ready to start.</div>
      </div>

      <div id="container">
        <div class="spinner" id="loadingSpinner"></div>
      </div>

      <div class="instructions">
        Left Click: Rotate ‚Ä¢ Right Click: Pan ‚Ä¢ Scroll: Zoom
      </div>
    </div>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      import { OBJLoader } from "three/addons/loaders/OBJLoader.js";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";

      // --- UI Logic: Update filename when selected ---
      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          const fileName = e.target.files[0]?.name;
          const display = document.getElementById("fileNameDisplay");
          if (fileName) {
            display.innerText = "‚úÖ Selected: " + fileName;
            display.style.color = "#4f46e5";
            display.style.borderColor = "#4f46e5";
          } else {
            display.innerText = "üìÇ Click to Select Floorplan Image";
            display.style.color = "#6b7280";
            display.style.borderColor = "#d1d5db";
          }
        });

      // --- 1. Initialize 3D Scene ---
      const container = document.getElementById("container");
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1a1a1a);

      // Camera
      const camera = new THREE.PerspectiveCamera(
        45,
        container.clientWidth / container.clientHeight,
        0.1,
        10000
      );
      camera.position.set(200, 300, 300);

      // Renderer
      const renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true,
      });
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      container.appendChild(renderer.domElement);

      // Controls
      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      // Lighting
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);

      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(100, 200, 100);
      scene.add(dirLight);

      const backLight = new THREE.DirectionalLight(0xffffff, 0.3);
      backLight.position.set(-100, -50, -100);
      scene.add(backLight);

      // Grid Helper
      const gridHelper = new THREE.GridHelper(1000, 50, 0x444444, 0x222222);
      scene.add(gridHelper);

      // Animation Loop
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      // Resize Handling
      window.addEventListener("resize", () => {
        const width = container.clientWidth;
        const height = container.clientHeight;
        renderer.setSize(width, height);
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
      });

      // --- 2. Upload & Load Logic ---
      window.uploadAndRun = async function () {
        const fileInput = document.getElementById("fileInput");
        const statusText = document.getElementById("statusText");
        const spinner = document.getElementById("loadingSpinner");
        const runBtn = document.getElementById("runBtn");

        if (fileInput.files.length === 0) {
          statusText.innerText = "‚ö†Ô∏è Please select a file first!";
          statusText.style.color = "#ef4444";
          return;
        }

        // Cleanup old model
        for (let i = scene.children.length - 1; i >= 0; i--) {
          const obj = scene.children[i];
          if (
            (obj.type === "Group" || obj.type === "Mesh") &&
            obj !== gridHelper
          ) {
            scene.remove(obj);
          }
        }

        // UI Loading State
        statusText.innerText = "Processing image & generating 3D model...";
        statusText.style.color = "#4f46e5";
        spinner.style.display = "block";
        runBtn.disabled = true;
        runBtn.style.opacity = "0.7";

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        try {
          // Send to Python
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Server Error");
          }

          statusText.innerText = "Downloading model...";

          // Load OBJ
          const loader = new OBJLoader();
          loader.load(
            data.model_url,
            function (object) {
              // Success
              spinner.style.display = "none";
              statusText.innerText = "‚ú® Model Generated Successfully!";
              statusText.style.color = "#10b981";
              runBtn.disabled = false;
              runBtn.style.opacity = "1";

              // Center model
              const box = new THREE.Box3().setFromObject(object);
              const center = box.getCenter(new THREE.Vector3());
              object.position.sub(center);

              // Material
              const material = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                roughness: 0.6,
                metalness: 0.1,
                side: THREE.DoubleSide,
              });

              object.traverse(function (child) {
                if (child.isMesh) {
                  child.material = material;
                  child.geometry.computeVertexNormals();
                }
              });

              scene.add(object);
            },
            undefined,
            function (error) {
              console.error(error);
              statusText.innerText = "‚ùå Failed to load 3D model.";
              statusText.style.color = "#ef4444";
              spinner.style.display = "none";
              runBtn.disabled = false;
            }
          );
        } catch (err) {
          console.error(err);
          statusText.innerText = "‚ùå Error: " + err.message;
          statusText.style.color = "#ef4444";
          spinner.style.display = "none";
          runBtn.disabled = false;
          runBtn.style.opacity = "1";
        }
      };
    </script>
  </body>
</html>
